<link rel="stylesheet" href="../../../bower_components/dropzone/dist/min/dropzone.min.css">
<script src="../../../bower_components/dropzone/dist/min/dropzone.min.js"></script>
<dom-module id="sdb-dropzone">

  <style>
    :host {
      display: block;
    }

    div#my-dropzone-area {

    }
  </style>

  <template>
    <paper-button on-tap="startTheMessage">Test Fire!</paper-button>
    <iron-signals on-iron-signal-hello="passTheMessage">
    <iron-signals on-iron-signal-user-login="_processAuth"></iron-signals>

      <div class="dropzone" id="sdb-dropzone-area">
        <div class="fallback">
          fallback
        </div>
      </div>

  </template>
</dom-module>

<script>
  (function() {
    Polymer({
      is: 'sdb-dropzone',
      ready: function() {
        this._token = '';
      },
      attached: function() {
        // access a local DOM element by ID using this.$
        this.dropzone = new Dropzone(
          '#sdb-dropzone-area',
          {
              url: 'http://scdl.reeve.co.nz/api/image',
              parallelUploads: 2,
              maxFileSize: 10,
              uploadMultiple: false,
              addRemoveLinks: true,
              acceptedFiles: '.jpg,.jpeg',
              headers: {
                  "Authorization": "Bearer " + this._token
              }
          });
        
        this.dropzone.options.sdbDropzoneArea = {
          paramName: 'file',
          maxFilesize: 10, // MB
          uploadMultiple: true,
          acceptedFiles: '.jpg,.jpeg',
          parallelUploads: 2,
          addRemoveLinks: true,
          url: this.rootUrl + 'api/image',
          init: function() {
            this.on('addedfile', function(file) {
              console.log('Added file.');
              console.log(file);
            });
            this.on('sending', function(file, xhr, formData) {
              console.log('Sending file.');
              formData.append('api_key', 0000000000000);
              formData.append('timestamp', Date.now() / 1000);
              formData.append('upload_preset', 'where-ky');
            });
            this.on('success', function(file, response) {
              var baseURL = '/';
              var url = baseURL.concat(response.public_id);
              console.log('Cloudinary URL: ', url);
              this.fire('iron-signal', {
                name: 'hello',
                data: null
              });
            });
          }
        };
        
        
      },
      _processAuth: function (e, data, sender) {
          if (data.token) {
              this._token = data.token;
              if (this.dropzone) {
                this.dropzone.options.headers = {
                  "Authorization": "Bearer " + this._token
                };
              }
          }
      },
      startTheMessage: function() {
        this.fire('iron-signal', {
          name: 'hello',
          data: null
        });
      },
      passTheMessage: function() {
        alert("got it");
      },
      properties: {},
    });
  })();
</script>